{
  "__id": "9f52a7ae-65e7-4829-9dc0-dfce1755bd78",
  "__name": "(1С) Создать сверхурочную работу",
  "code": "overtime_work_create",
  "namespace": "ext_7fe3de7d-f459-4f75-940c-271c6e9ea1ed",
  "type": [
    {
      "code": "script",
      "name": "Скрипт"
    }
  ],
  "group": "7fe3de7d-f459-4f75-940c-271c6e9ea1ed",
  "icon": "system",
  "color": "#20c997",
  "itemName": "",
  "description": "",
  "retryCount": 10,
  "retryDelay": 5,
  "context": [
    {
      "code": "org_id",
      "type": "STRING",
      "searchable": false,
      "indexed": false,
      "deleted": false,
      "array": false,
      "required": true,
      "single": true,
      "defaultValue": null,
      "calcByFormula": false,
      "formula": "",
      "data": {},
      "view": {
        "name": "id Организации",
        "data": {
          "additionalType": "string"
        },
        "input": true
      }
    },
    {
      "code": "response",
      "type": "STRING",
      "searchable": false,
      "indexed": false,
      "deleted": false,
      "array": false,
      "required": false,
      "single": true,
      "defaultValue": null,
      "calcByFormula": false,
      "formula": "",
      "data": {},
      "view": {
        "name": "Ответ",
        "data": {
          "additionalType": "string"
        },
        "output": true
      }
    },
    {
      "code": "error",
      "type": "STRING",
      "searchable": false,
      "indexed": false,
      "deleted": false,
      "array": false,
      "required": false,
      "single": true,
      "defaultValue": null,
      "calcByFormula": false,
      "formula": "",
      "data": {},
      "view": {
        "name": "Ошибка",
        "data": {
          "additionalType": "string"
        },
        "output": true
      }
    },
    {
      "code": "reason",
      "type": "STRING",
      "searchable": false,
      "indexed": false,
      "deleted": false,
      "array": false,
      "required": false,
      "single": true,
      "defaultValue": null,
      "calcByFormula": false,
      "formula": "",
      "data": {},
      "view": {
        "name": "Причина",
        "data": {
          "additionalType": "string"
        },
        "input": true
      }
    },
    {
      "code": "employee_data",
      "type": "STRING",
      "searchable": false,
      "indexed": false,
      "deleted": false,
      "array": false,
      "required": true,
      "single": true,
      "defaultValue": null,
      "calcByFormula": false,
      "formula": "",
      "data": {},
      "view": {
        "name": "Данные сотрудников",
        "data": {
          "additionalType": "string"
        },
        "input": true
      }
    },
    {
      "code": "alternative_way",
      "type": "BOOLEAN",
      "searchable": false,
      "indexed": false,
      "deleted": false,
      "array": false,
      "required": false,
      "single": true,
      "defaultValue": false,
      "calcByFormula": false,
      "formula": "",
      "data": {},
      "view": {
        "name": "Альтернативная интеграция",
        "data": {
          "additionalType": "radio",
          "noValue": "Нет",
          "yesValue": "Да"
        },
        "input": true
      }
    },
    {
      "code": "integration_app_id",
      "type": "STRING",
      "searchable": false,
      "indexed": false,
      "deleted": false,
      "array": false,
      "required": false,
      "single": true,
      "defaultValue": null,
      "calcByFormula": false,
      "formula": "",
      "data": {},
      "view": {
        "name": "id Приложения интеграции",
        "data": {
          "additionalType": "string"
        },
        "input": false,
        "output": true
      }
    },
    {
      "code": "individual_id_1c",
      "type": "STRING",
      "searchable": false,
      "indexed": false,
      "deleted": false,
      "array": false,
      "required": false,
      "single": true,
      "defaultValue": null,
      "calcByFormula": false,
      "formula": "",
      "data": {},
      "view": {
        "name": "ИД ФЛ 1С",
        "data": {
          "additionalType": "string"
        },
        "input": true
      }
    },
    {
      "code": "comment",
      "type": "STRING",
      "searchable": false,
      "indexed": false,
      "deleted": false,
      "array": false,
      "required": false,
      "single": true,
      "defaultValue": null,
      "calcByFormula": false,
      "formula": "",
      "data": {},
      "view": {
        "name": "Комментарий",
        "data": {
          "additionalType": "string"
        },
        "input": true
      }
    },
    {
      "code": "base_1c_name",
      "type": "STRING",
      "searchable": false,
      "indexed": false,
      "deleted": false,
      "array": false,
      "required": false,
      "single": true,
      "defaultValue": null,
      "calcByFormula": false,
      "formula": "",
      "data": {},
      "view": {
        "name": "Имя подключения 1С",
        "data": {
          "additionalType": "string"
        },
        "input": true
      }
    },
    {
      "code": "additional_info",
      "type": "STRING",
      "searchable": false,
      "indexed": false,
      "deleted": false,
      "array": false,
      "required": false,
      "single": true,
      "defaultValue": null,
      "calcByFormula": false,
      "formula": "",
      "data": {},
      "view": {
        "name": "Дополнительная информация",
        "data": {
          "additionalType": "string"
        },
        "input": true
      }
    }
  ],
  "draft": false,
  "published": true,
  "data": {
    "scripts": "interface employees {\n\tid: string;\n\tindividualId: string;\n\tdate: string; //datetime.format('YYYY-MM-DD')\n\thours: number;\n}\n\nconst baseUrl = Namespace.params.data.url_1c_odata;\nconst login = Namespace.params.data.login;\nconst password = Namespace.params.data.password;\nconst myHeaders = {\n\tAuthorization: `Basic ${btoa(login + ':' + password)}`,\n};\n\nasync function action(): Promise\u003cvoid\u003e {\n\tconst currentDate = new TDate();\n\tconst employeeData = JSON.parse(Context.data.employee_data!)\n\n\tconst individuals: any[] = [];\n\tconst overtimeWorkTable: any[] = [];\n\temployeeData.forEach((item: any) =\u003e {\n\t\tovertimeWorkTable.push({\n\t\t\t\"LineNumber\": `${overtimeWorkTable.length + 1}`,\n\t\t\t\"Сотрудник_Key\": item.id,\n\t\t\t\"Дата\": `${item.date}T00:00:00`,\n\t\t\t\"ОтработаноЧасов\": item.hours,\n\t\t\t\"СпособКомпенсацииПереработки\": \"ПовышеннаяОплата\"\n\t\t})\n\n\t\tconst isEmployeeExisting = individuals.find((individual: any) =\u003e individual[\"ФизическоеЛицо_Key\"] === item.individualId)\n\t\tif (!isEmployeeExisting) {\n\t\t\tindividuals.push({\n\t\t\t\t\"LineNumber\": `${individuals.length + 1}`,\n\t\t\t\t\"ФизическоеЛицо_Key\": item.individualId\n\t\t\t})\n\t\t}\n\t})\n\n\n\tconst body = {\n\t\t\"Date\": `${currentDate.format('YYYY-MM-DD')}T00:00:00`,\n\t\t\"ПериодРегистрации\": `${currentDate.format('YYYY-MM')}-01T00:00:00`,\n\t\t\"Организация_Key\": Context.data.org_id,\n\t\t\"Причина\": Context.data.reason || '',\n\t\t\"СогласиеПолучено\": true,\n\t\t\"БухучетЗаданВСтрокахДокумента\": false,\n\t\t\"Сотрудники\": overtimeWorkTable,\n\t\t\"Комментарий\" : Context.data.comment ?? \"\",\n\t}\n\n\tif (!Context.data.alternative_way) {\n\t\tconst requestOptions: FetchRequest = {\n\t\t\tmethod: 'POST',\n\t\t\theaders: myHeaders,\n\t\t};\n\t\trequestOptions.body = JSON.stringify(body);\n\t\tContext.data.debug = 'fetch'\n\t\tconst resUrl = `${baseUrl}/Document_РаботаСверхурочно?$format=json`;\n\n\t\ttry {\n\t\t\tconst response = await fetch(`${encodeURI(resUrl)}`, requestOptions)\n\t\t\tif (!response.ok) {\n\t\t\t\tContext.data.error += ` staff data res.status error; resUrl - ${resUrl} `\n\t\t\t\tthrow new Error(`res error ${resUrl}`);\n\t\t\t}\n\n\t\t\tContext.data.response = JSON.stringify(await response.json());\n\t\t} catch (err) {\n\t\t\tContext.data.error += ` try/catch error ${err}; resUrl - ${resUrl} `\n\t\t\tthrow new Error(err)\n\t\t}\n\t} else {\n\t\tconst accounting1c = Namespace.params.fields.awaiting_docs_table_1c.app.fields.accounting_systems.variants.zup_1c\n\t\tconst awaitingApp = Namespace.params.fields.awaiting_docs_table_1c.app.create()\n\t\tawaitingApp.data.__name = \"Работа в нерабочее время\"\n\t\tawaitingApp.data.document_odata_name = \"Document_РаботаСверхурочно\"\n\t\tawaitingApp.data.accounting_systems = accounting1c\n\t\tawaitingApp.data.personal_guid_1c = JSON.stringify([Context.data.individual_id_1c])\n\t\tawaitingApp.data.document_creation_data = JSON.stringify(body);\n\t\tawaitingApp.data.additional_info = Context.data.additional_info ?? \"\";\n\t\tawaitingApp.data.base_1c_name = Context.data.base_1c_name ?? undefined;\n\t\tawait awaitingApp.save()\n\n\t\tContext.data.integration_app_id = awaitingApp.data.__id\n\t}\n}",
    "execution": [
      {
        "code": "sync",
        "name": "Синхронное"
      }
    ],
    "allowGlobal": false,
    "checkInterval": ""
  },
  "async": false,
  "__createdAt": "2023-12-20T13:08:01.979563561Z",
  "__createdBy": "7303b866-4220-4086-a09e-348a76b12c73",
  "__updatedAt": "2024-02-14T11:09:54.714180728Z",
  "__updatedBy": "7303b866-4220-4086-a09e-348a76b12c73",
  "__deletedAt": null
}
