{"__id":"018e89f9-219a-7a9e-8d5b-5057ca68aa43","namespace":"kedo.settings","code":"form_a0d2acd7-443a-4d97-bc50-535889b0215b","__name":"Проверить состояние модулей решения","description":"","extensionZoneCode":"","sort":0,"category":"00000000-0000-0000-0000-000000000000","version":2,"hidden":true,"draft":false,"readonly":false,"descriptor":{"types":["form"],"template":{"id":"23ba780e-7743-45d6-96da-48f5f3be314b","descriptor":"item-form-complex-popup","descriptorVersion":2,"values":{"formType":"task-form","formGroup":{"path":["context"]},"systemFunctions":{"validate":{"kind":"Function","name":"validation","type":"client"}}},"content":{"[footer]":[{"id":"31979bac-00bd-4123-a901-9d14190c8dde","descriptor":"buttons-panel","values":{"buttons":{"path":["actionButtons"]}}}],"[content]":[{"id":"c18e9118-cda2-49f4-ae50-5414c9b970b2","descriptor":"modal-body","values":{"shadow":true},"content":{"":[{"id":"dfab852b-845d-475a-8b6e-155f5e3a8355","descriptor":"html","descriptorVersion":3,"values":{"html":"\u003cp\u003e\u003cspan style=\"font-size: 14pt;\"\u003eПерейдите в настройки модулей, приведенных в таблице, и включите их\u003c/span\u003e\u003c/p\u003e"}},{"id":"1490594e-5ab2-447e-b565-a10b2c55d558","descriptor":"code","values":{"html":"\u003c% if (ViewContext.data.modules) { %\u003e\n    \u003ctable class=\"table\" id=\"modules-table\"\u003e\n        \u003cthead\u003e\n            \u003cth\u003eНазвание\u003c/th\u003e\n            \u003cth\u003eСостояние\u003c/th\u003e\n        \u003c/thead\u003e\n        \u003c% for (const module of ViewContext.data.modules) { %\u003e\n            \u003ctr\u003e\n                \u003ctd\u003e\u003ca href=\"\u003c%= module.url %\u003e\" target=\"_blank\"\u003e\u003c%= module.name %\u003e\u003c/a\u003e\u003c/td\u003e\n                \u003c% if (module.enabled == true) { %\u003e\n                    \u003ctd class=\"enabled-module\"\u003eВключен\u003c/td\u003e\n                \u003c% } else { %\u003e\n                    \u003ctd class=\"disabled-module\"\u003eВыключен\u003c/td\u003e\n                \u003c% } %\u003e\n            \u003c/tr\u003e\n        \u003c% } %\u003e\n    \u003c/table\u003e\n\u003c% } %\u003e\n\n\u003cstyle\u003e\n    .enabled-module {\n        background-color : #cef0d0;\n    }\n\n    .disabled-module {\n        background-color : #FCEAEA;\n    }\n\u003c/stlye\u003e","hideContent":false,"contentPlaceholder":""}}]}}],"[sidebar]":[{"id":"39d7757a-529f-4526-98f3-fddc66becf85","descriptor":"sidebar-widget","content":{"":[{"id":"abe4b782-6e2d-49cc-a57e-81b636422ee5","descriptor":"target-widget","values":{"context":{"path":["context"]}}}]}},{"id":"231b371a-64ae-4b61-8014-cba6da318ac9","descriptor":"sidebar-widget","content":{"":[{"id":"5e39b91d-aea4-467e-862f-0f8766eb44df","descriptor":"linked-item","values":{"context":{"path":["context"]}}}]}},{"id":"a4469de0-d7f3-11ec-9d64-0242ac120002","descriptor":"sidebar-widget","content":{"":[{"id":"3ead7c41-6dfa-4144-80da-2bfb5f0ccf59","descriptor":"item-reminder","values":{"formGroup":{"path":["context"]}}}]}},{"id":"56d1d0e8-aa83-4cdd-ae43-294b26ad4d04","descriptor":"sidebar-widget","content":{"":[{"id":"e1525e34-14ba-456b-b703-f407945c01e0","descriptor":"item-tasks","descriptorVersion":4,"values":{"formGroup":{"path":["context"]},"itemModel":{"path":["itemModel"]}}}]}},{"id":"eef018f2-1d3a-4600-a19d-791733b28b5e","descriptor":"sidebar-widget","content":{"":[{"id":"e0a17dec-603a-461a-becf-861637630584","descriptor":"messages-target","values":{"target":{"path":["target"]}}}]}}],"[formInfoPanel]":[{"id":"8be213ea-fad8-4b2d-adbc-5c541b5cf13f","descriptor":"validation-info-block","values":{"__validateResult":{"path":["context","__validateResult"]}}}],"[headerControls]":[{"id":"475aa008-aaff-402f-8de2-408bae1f1928","descriptor":"task-percent-widget","values":{"task":{"path":["task"]}}},{"id":"702d9c59-77ae-4dd5-b71a-a5fe7b58858f","descriptor":"extension-zone-toolbar-widget","values":{"item":{"path":["__itemRef"]}}},{"id":"f7b11c79-4267-4f5b-a002-dd629d549682","descriptor":"process-item-map","values":{"task":{"path":["task"]},"skipRulesCheck":true}},{"id":"ff2500ee-6573-49cd-a9e8-2d5c93350f26","descriptor":"button","values":{"label":"bpm.tasks.item@menu","action":{"path":["menuAction"]},"runProcessSettings":{"kind":"","settings":{"code":"","field":"","binding":null,"namespace":""}},"createAppItemSettings":{"kind":"","settings":{"code":"","field":"","binding":null,"namespace":""}},"icon":"menu_vertical","view":"icon"}}],"[headerCustomization]":[]}},"fields":[{"code":"modules","type":"JSON","searchable":false,"indexed":false,"deleted":false,"array":false,"required":false,"single":true,"defaultValue":null,"calcByFormula":false,"formula":"","data":{},"view":{"name":"Модули","data":{}}},{"code":"task_id","type":"STRING","searchable":false,"indexed":false,"deleted":false,"array":false,"required":false,"single":true,"defaultValue":null,"calcByFormula":false,"formula":"","data":{},"view":{"name":"ID задачи","data":{"additionalType":"string"},"input":true,"output":true}}],"fieldVisibilityConditions":{"modules":{"enabled":false,"conditions":[]},"task_id":{"enabled":false,"conditions":[]}},"scriptOptions":{},"clientScripts":"/* Client scripts module */\n\ndeclare const document: any;\ndeclare const window: any;\ndeclare const console: any;\n\ninterface IModule {\n    __createdAt: TDatetime,\n    __createdBy: string,\n    __deletedAt: TDatetime,\n    __id: string,\n    __updatedAt: TDatetime,\n    __updatedBy: string,\n    author: string,\n    code: string,\n    description: string,\n    enabled: boolean,\n    help: string,\n    language: string,\n    name: string,\n    namespace: string,\n    summary: string,\n    website: string,\n    url?: string,\n}\n\nasync function onInit(): Promise\u003cvoid\u003e {\n    ViewContext.data.task_id = ViewContext.data.__itemRef.id;\n    await getModules();\n}\n\n// Каждые 3 секунды запускаем скрипт получения состояния модулей, чтобы на форме отображалась актуальная информация.\nasync function getModules(): Promise\u003cvoid\u003e {\n    //#region \n    /**\n     * Проверка, открыта ли задача в данный момент.\n     * Если задача закрыта, то останавливаем выполнение запросов на получение состояния модулей.\n     * Получаем адресную строку у текущей вкладки и проверяем наличие ID задачи. \n     */\n    const location = window.location.href;\n\n    if (!location.includes(ViewContext.data.task_id)) {\n        return;\n    }\n    //#end\n\n    await Server.rpc.getModules();\n\n    const modules: IModule[] = ViewContext.data.modules ?? [];\n    modules.forEach(f =\u003e f.url = `${System.getBaseUrl()}/admin/extensions/ext_${f.__id}`);\n\n    window.setTimeout(getModules, 3000);\n}\n\nasync function validation(): Promise\u003cValidationResult\u003e {\n    const result = new ValidationResult();\n\n    const modules: IModule[] = ViewContext.data.modules ?? [];\n\n    if (modules.some(m =\u003e m.enabled == false)) {\n        result.addMessage(\"Имеются выключенные модули. Проверьте модули и включите их.\");\n    }\n\n    return result;\n}\n","clientScriptOptions":{"allowServer":true},"serverScripts":"/* Server scripts module */\n\ninterface IModule {\n    __createdAt: TDatetime,\n    __createdBy: string,\n    __deletedAt: TDatetime,\n    __id: string,\n    __updatedAt: TDatetime,\n    __updatedBy: string,\n    author: string,\n    code: string,\n    description: string,\n    enabled: boolean,\n    help: string,\n    language: string,\n    name: string,\n    namespace: string,\n    summary: string,\n    website: string,\n}\n\nconst getModulesIds = (): string[] =\u003e {\n  let ids = [\n    // Интеграция с УЦ.\n    \"27c1fb4a-e011-47a6-aa26-cf0fc42c39cd\",\n    // Модуль КЭДО.\n    \"7fe3de7d-f459-4f75-940c-271c6e9ea1ed\",\n  ];\n\n  // Интеграция с 1С\n  if (Context.data.need_integration_1c == true) {\n    ids.push(\"3c26e96d-9ba5-486d-a26e-47918e61fad3\");\n  }\n\n  return ids;\n}\n\n\nasync function getModules(): Promise\u003cvoid\u003e {\n    const modules: IModule[] = [];\n\n    try {\n        const requests = getModulesIds().map(id =\u003e fetch(`${System.getBaseUrl()}/pub/v1/scheme/modules/${id}`, {\n            method: \"GET\",\n            headers: {\n                \"Authorization\": `Bearer ${Context.data.token!}`,\n            }\n        }));\n\n        await Promise.all(requests)\n            .then(responses =\u003e Promise.all(responses.map(r =\u003e r.json())))\n            .then(data =\u003e data.forEach(moduleResponse =\u003e {\n                modules.push(moduleResponse.module)\n            }));\n\n        ViewContext.data.modules = modules.filter(f =\u003e f != null \u0026\u0026 f != undefined);\n\n    } catch (error) {\n        throw new Error(error);\n    }\n}","serverScriptOptions":{},"dataFieldCode":"context"},"dataNamespace":"kedo.settings","dataCode":"_process_initial_configure_kedo_workflow","runtime":{"version":1,"clientScripts":"System.register([], function (exports_1, context_1) {\n    \"use strict\";\n    var __moduleName = context_1 \u0026\u0026 context_1.id;\n    function default_1(Context, ViewContext, Server, System) {\n        async function onInit() {\n            ViewContext.data.task_id = ViewContext.data.__itemRef.id;\n            await getModules();\n        }\n        async function getModules() {\n            var _a;\n            const location = window.location.href;\n            if (!location.includes(ViewContext.data.task_id)) {\n                return;\n            }\n            await Server.rpc.getModules();\n            const modules = (_a = ViewContext.data.modules) !== null \u0026\u0026 _a !== void 0 ? _a : [];\n            modules.forEach(f =\u003e f.url = `${System.getBaseUrl()}/admin/extensions/ext_${f.__id}`);\n            window.setTimeout(getModules, 3000);\n        }\n        async function validation() {\n            var _a;\n            const result = new ValidationResult();\n            const modules = (_a = ViewContext.data.modules) !== null \u0026\u0026 _a !== void 0 ? _a : [];\n            if (modules.some(m =\u003e m.enabled == false)) {\n                result.addMessage(\"Имеются выключенные модули. Проверьте модули и включите их.\");\n            }\n            return result;\n        }\n        return {\n            onInit,\n            getModules,\n            validation\n        };\n    }\n    exports_1(\"default\", default_1);\n    return {\n        setters: [],\n        execute: function () {\n        }\n    };\n});\n","clientFnDeclarations":[{"name":"onInit","parameters":[],"type":"[object Object]"},{"name":"getModules","parameters":[],"type":"[object Object]"},{"name":"validation","parameters":[],"type":"[object Object]"}],"serverScripts":"const getModulesIds = () =\u003e {\n    let ids = [\n        \"27c1fb4a-e011-47a6-aa26-cf0fc42c39cd\",\n        \"7fe3de7d-f459-4f75-940c-271c6e9ea1ed\",\n    ];\n    if (Context.data.need_integration_1c == true) {\n        ids.push(\"3c26e96d-9ba5-486d-a26e-47918e61fad3\");\n    }\n    return ids;\n};\nasync function getModules() {\n    const modules = [];\n    try {\n        const requests = getModulesIds().map(id =\u003e fetch(`${System.getBaseUrl()}/pub/v1/scheme/modules/${id}`, {\n            method: \"GET\",\n            headers: {\n                \"Authorization\": `Bearer ${Context.data.token}`,\n            }\n        }));\n        await Promise.all(requests)\n            .then(responses =\u003e Promise.all(responses.map(r =\u003e r.json())))\n            .then(data =\u003e data.forEach(moduleResponse =\u003e {\n            modules.push(moduleResponse.module);\n        }));\n        ViewContext.data.modules = modules.filter(f =\u003e f != null \u0026\u0026 f != undefined);\n    }\n    catch (error) {\n        throw new Error(error);\n    }\n}\n","serverFnDeclarations":[{"name":"getModules","parameters":[],"type":"[object Object]"}],"clientDependencies":{"applications":[],"collections":[],"pages":[]}},"__createdAt":"2024-03-29T11:29:49.463856547Z","__createdBy":"d78f4b2f-13a2-4903-aeeb-fdb72d5b9d0c","__updatedAt":"2024-04-18T12:21:24.602887388Z","__updatedBy":"8c6e1940-a6f3-4603-aff7-7cdf41cc9799","__deletedAt":null}
