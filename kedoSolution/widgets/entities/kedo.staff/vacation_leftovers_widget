{
  "__id": "018f0a75-4928-7a26-8eed-0ea22790d1cb",
  "namespace": "kedo.staff",
  "code": "vacation_leftovers_widget",
  "__name": "Остатки отпусков",
  "description": "",
  "extensionZoneCode": "",
  "sort": 0,
  "category": "00000000-0000-0000-0000-000000000000",
  "version": 1,
  "hidden": false,
  "draft": false,
  "readonly": false,
  "descriptor": {
    "icon": "system_brightness",
    "template": {
      "id": "04f94629-5e64-41d6-b244-06623edfe939",
      "descriptor": "component",
      "values": {
        "systemFunctions": {}
      },
      "content": {
        "": [
          {
            "id": "d6b63c52-5f16-4033-85e4-42e973dc19ef",
            "descriptor": "dynamic-form-row",
            "values": {
              "control": {
                "path": ["vacation_leftover_table"]
              },
              "tooltip": null,
              "required": false,
              "hideEmpty": false,
              "__readOnly": true,
              "__isConstValues": [],
              "showDisplayName": false,
              "__outlet": "",
              "__baseURL": "",
              "bindingMode": false,
              "__relativeURL": "",
              "__renderContentOnDemand": false
            }
          }
        ]
      }
    },
    "fields": [
      {
        "code": "staff",
        "type": "SYS_COLLECTION",
        "searchable": false,
        "indexed": false,
        "deleted": false,
        "array": true,
        "required": false,
        "single": true,
        "defaultValue": null,
        "calcByFormula": false,
        "formula": "",
        "data": {
          "code": "staff",
          "filter": {
            "value": {
              "tf": {}
            },
            "enabled": false
          },
          "bindings": null,
          "namespace": "kedo",
          "isDependent": false,
          "linkedFieldCode": ""
        },
        "view": {
          "name": "Сотрудник",
          "data": {},
          "input": true,
          "output": false
        }
      },
      {
        "code": "vacation_leftover_table",
        "type": "TABLE",
        "searchable": false,
        "indexed": false,
        "deleted": false,
        "array": false,
        "required": false,
        "single": true,
        "defaultValue": null,
        "calcByFormula": false,
        "formula": "",
        "data": {
          "fields": [
            {
              "code": "__count",
              "data": null,
              "type": "FLOAT",
              "view": {
                "data": {
                  "additionalType": "integer"
                },
                "name": "Количество элементов",
                "system": true
              },
              "array": false,
              "single": true,
              "deleted": false,
              "formula": "",
              "indexed": false,
              "required": false,
              "searchable": false,
              "defaultValue": null,
              "calcByFormula": false
            },
            {
              "code": "__index",
              "data": {
                "result": {}
              },
              "type": "FLOAT",
              "view": {
                "data": {
                  "additionalType": "integer"
                },
                "name": "№",
                "disabled": true
              },
              "array": false,
              "single": true,
              "deleted": false,
              "formula": "",
              "indexed": true,
              "required": false,
              "searchable": false,
              "defaultValue": null,
              "calcByFormula": false
            },
            {
              "code": "employment_placement",
              "data": {
                "code": "employment_directory",
                "filter": {
                  "value": {
                    "tf": {}
                  },
                  "enabled": false
                },
                "bindings": null,
                "namespace": "kedo",
                "isDependent": false,
                "linkedFieldCode": ""
              },
              "type": "SYS_COLLECTION",
              "view": {
                "data": {
                  "showCreateItem": false
                },
                "name": "Место занятости"
              },
              "array": true,
              "single": true,
              "deleted": false,
              "formula": "",
              "indexed": false,
              "required": false,
              "searchable": false,
              "defaultValue": null,
              "calcByFormula": false
            },
            {
              "code": "leftovers",
              "data": {
                "fields": [
                  {
                    "code": "__count",
                    "data": null,
                    "type": "FLOAT",
                    "view": {
                      "data": {
                        "additionalType": "integer"
                      },
                      "name": "Количество элементов",
                      "system": true
                    },
                    "array": false,
                    "single": true,
                    "deleted": false,
                    "formula": "",
                    "indexed": false,
                    "required": false,
                    "searchable": false,
                    "defaultValue": null,
                    "calcByFormula": false
                  },
                  {
                    "code": "__index",
                    "data": {
                      "result": {}
                    },
                    "type": "FLOAT",
                    "view": {
                      "data": {
                        "additionalType": "integer"
                      },
                      "name": "№",
                      "disabled": true
                    },
                    "array": false,
                    "single": true,
                    "deleted": false,
                    "formula": "",
                    "indexed": true,
                    "required": false,
                    "searchable": false,
                    "defaultValue": null,
                    "calcByFormula": false
                  },
                  {
                    "code": "vacation_type",
                    "data": {
                      "code": "type_vacations_1c",
                      "filter": {
                        "value": {
                          "tf": {}
                        },
                        "enabled": false
                      },
                      "bindings": null,
                      "namespace": "kedo",
                      "isDependent": false,
                      "linkedFieldCode": ""
                    },
                    "type": "SYS_COLLECTION",
                    "view": {
                      "data": {
                        "showCreateItem": false
                      },
                      "name": "Тип отпуска"
                    },
                    "array": true,
                    "single": true,
                    "deleted": false,
                    "formula": "",
                    "indexed": false,
                    "required": false,
                    "searchable": false,
                    "defaultValue": null,
                    "calcByFormula": false
                  },
                  {
                    "code": "remainder",
                    "data": {},
                    "type": "FLOAT",
                    "view": {
                      "data": {
                        "additionalType": "integer",
                        "showRowSeparator": true
                      },
                      "name": "Остаток"
                    },
                    "array": false,
                    "single": true,
                    "deleted": false,
                    "formula": "",
                    "indexed": false,
                    "required": false,
                    "searchable": false,
                    "defaultValue": null,
                    "calcByFormula": false
                  }
                ],
                "result": {
                  "__count": {
                    "kind": "none",
                    "label": "",
                    "formula": "sum"
                  },
                  "__index": {
                    "kind": "none",
                    "label": "",
                    "formula": "sum"
                  },
                  "remainder": {
                    "kind": "formula",
                    "label": "",
                    "formula": "sum"
                  },
                  "vacation_type": {
                    "kind": "label",
                    "label": "Сумма остатков",
                    "formula": ""
                  }
                }
              },
              "type": "TABLE",
              "view": {
                "data": {
                  "columnsView": {
                    "remainder": {
                      "key": false,
                      "font": {
                        "bold": false,
                        "color": "",
                        "italic": false,
                        "underline": false
                      },
                      "align": "left",
                      "width": 175,
                      "hidden": false,
                      "tensile": false,
                      "readonly": false,
                      "required": false,
                      "compression": false,
                      "verticalAlign": "middle",
                      "backgroundColor": ""
                    },
                    "vacation_type": {
                      "key": false,
                      "font": {
                        "bold": false,
                        "color": "",
                        "italic": false,
                        "underline": false
                      },
                      "align": "left",
                      "width": 175,
                      "hidden": false,
                      "tensile": false,
                      "readonly": false,
                      "required": false,
                      "compression": false,
                      "verticalAlign": "middle",
                      "backgroundColor": ""
                    }
                  },
                  "maxRowCount": 0,
                  "viewVariant": "table",
                  "footerHidden": false,
                  "headerHidden": false,
                  "rowMinHeight": 35,
                  "viewTemplate": "Элементов: {$__count}",
                  "relativeWidth": true,
                  "allowDeleteRows": false,
                  "groupingSettings": {
                    "code": "",
                    "kind": "None",
                    "sort": "asc"
                  },
                  "showOrderNumbers": false,
                  "collapseNestedHeaders": false
                },
                "name": "Остатки отпусков"
              },
              "array": false,
              "single": true,
              "deleted": false,
              "formula": "",
              "indexed": false,
              "required": false,
              "searchable": false,
              "defaultValue": null,
              "calcByFormula": false
            }
          ],
          "result": {
            "__count": {
              "kind": "none",
              "label": "",
              "formula": "sum"
            },
            "__index": {
              "kind": "none",
              "label": "",
              "formula": "sum"
            },
            "leftovers": {
              "kind": "none",
              "label": "",
              "formula": "sum"
            },
            "employment_placement": {
              "kind": "none",
              "label": "",
              "formula": "sum"
            }
          }
        },
        "view": {
          "name": "Таблица остатков отпусков",
          "data": {
            "allowDeleteRows": false,
            "collapseNestedHeaders": false,
            "columnsView": {
              "employment_placement": {
                "align": "left",
                "compression": false,
                "font": {
                  "bold": false,
                  "color": "",
                  "italic": false,
                  "underline": false
                },
                "hidden": false,
                "readonly": false,
                "required": false,
                "tensile": false,
                "verticalAlign": "middle",
                "width": 175
              },
              "leftovers": {
                "align": "left",
                "compression": false,
                "font": {
                  "bold": false,
                  "color": "",
                  "italic": false,
                  "underline": false
                },
                "hidden": false,
                "readonly": false,
                "required": false,
                "tensile": false,
                "verticalAlign": "middle",
                "width": 350
              }
            },
            "footerHidden": false,
            "groupingSettings": {
              "code": "",
              "kind": "None",
              "sort": "asc"
            },
            "headerHidden": false,
            "maxRowCount": 0,
            "relativeWidth": true,
            "rowMinHeight": 35,
            "showOrderNumbers": false,
            "viewTemplate": "Элементов: {$__count}",
            "viewVariant": "table"
          },
          "input": false,
          "output": false
        }
      },
      {
        "code": "vacation_leftovers_data",
        "type": "JSON",
        "searchable": false,
        "indexed": false,
        "deleted": false,
        "array": false,
        "required": false,
        "single": true,
        "defaultValue": null,
        "calcByFormula": false,
        "formula": "",
        "data": {},
        "view": {
          "name": "__oldДанные об остатках",
          "data": {},
          "input": false,
          "output": false
        }
      }
    ],
    "fieldVisibilityConditions": {
      "item": {
        "enabled": false,
        "conditions": []
      },
      "staff": {
        "enabled": false,
        "conditions": []
      },
      "fields": {
        "enabled": false,
        "conditions": []
      },
      "target": {
        "enabled": false,
        "conditions": []
      },
      "__hidden": {
        "enabled": false,
        "conditions": []
      },
      "__outlet": {
        "enabled": false,
        "conditions": []
      },
      "__styles": {
        "enabled": false,
        "conditions": []
      },
      "isLocked": {
        "enabled": false,
        "conditions": []
      },
      "__baseURL": {
        "enabled": false,
        "conditions": []
      },
      "__classes": {
        "enabled": false,
        "conditions": []
      },
      "__itemRef": {
        "enabled": false,
        "conditions": []
      },
      "fileModel": {
        "enabled": false,
        "conditions": []
      },
      "itemModel": {
        "enabled": false,
        "conditions": []
      },
      "__formType": {
        "enabled": false,
        "conditions": []
      },
      "__readOnly": {
        "enabled": false,
        "conditions": []
      },
      "application": {
        "enabled": false,
        "conditions": []
      },
      "permissions": {
        "enabled": false,
        "conditions": []
      },
      "routeParams": {
        "enabled": false,
        "conditions": []
      },
      "__relativeURL": {
        "enabled": false,
        "conditions": []
      },
      "actionButtons": {
        "enabled": false,
        "conditions": []
      },
      "__onMouseEnter": {
        "enabled": false,
        "conditions": []
      },
      "__onMouseLeave": {
        "enabled": false,
        "conditions": []
      },
      "accessSettings": {
        "enabled": false,
        "conditions": []
      },
      "buttonSettings": {
        "enabled": false,
        "conditions": []
      },
      "__isConstValues": {
        "enabled": false,
        "conditions": []
      },
      "addVersionAction": {
        "enabled": false,
        "conditions": []
      },
      "runProcessAction": {
        "enabled": false,
        "conditions": []
      },
      "bpTemplateBuilder": {
        "enabled": false,
        "conditions": []
      },
      "docflowSendAction": {
        "enabled": false,
        "conditions": []
      },
      "versionListAction": {
        "enabled": false,
        "conditions": []
      },
      "__renderContentAsync": {
        "enabled": false,
        "conditions": []
      },
      "__renderContentOnDemand": {
        "enabled": false,
        "conditions": []
      },
      "vacation_leftover_table": {
        "enabled": false,
        "conditions": []
      },
      "vacation_leftovers_data": {
        "enabled": false,
        "conditions": []
      }
    },
    "scriptOptions": {
      "allowNamespace": true
    },
    "clientScripts": "/* Client scripts module */\n\ninterface IVacationLeftover {\n    name: string,\n    position?: string,\n    remainder: number,\n}\n\ninterface IVacationLeftoverData {\n    position?: string,\n    leftovers: IVacationLeftover[],\n    sum: number,\n}\n\ndeclare const console: any;\n\nasync function onInit(): Promise\u003cvoid\u003e {\n    getActualLeftovers();\n}\n\nasync function getActualLeftovers(): Promise\u003cvoid\u003e {\n    if (!Context.data.staff) {\n        throw new Error(\"Context.data.staff is undefined\");\n    }\n\n    const staff = await Context.data.staff.fetch();\n\n    if (!staff.data.employment_table || staff.data.employment_table.length == 0) {\n        throw new Error(\"У сотрудника не указаны места занятости\");\n    }\n\n    const vacation_leftovers = await Namespace.app.vacation_leftovers.search()\n        .where((f, g) =\u003e g.and(\n            f.__deletedAt.eq(null),\n            f.staff.link(staff)\n        ))\n        .size(10000)\n        .all();\n\n    const employment_table = staff.data.employment_table ?? staff.fields.employment_table.create();\n\n    const employment_placement_ids = employment_table\n        .filter(f =\u003e f.employment_placement_app)\n        .map(f =\u003e f.employment_placement_app.id);\n\n    const employment_placements = await Namespace.app.employment_directory.search()\n        .where((f, g) =\u003e g.and(\n            f.__deletedAt.eq(null),\n            f.__id.in(employment_placement_ids),\n            f.__status.eq(Namespace.app.employment_directory.fields.__status.variants.actual),\n            f.staff.link(staff),\n        ))\n        .size(employment_placement_ids.length)\n        .all();\n\n    const vacation_leftover_table = Context.fields.vacation_leftover_table.create();\n\n    for (const employment_placement of employment_placements) {\n        if (!employment_placement.data.position) continue;\n\n        const leftovers = vacation_leftovers.filter(f =\u003e f.data.position?.id == employment_placement.data.position?.id);\n\n        if (leftovers.length == 0) continue;\n\n        const row = vacation_leftover_table.insert();\n\n        const leftovers_table = Context.fields.vacation_leftover_table.fields.leftovers.create();\n\n        for (const leftover of leftovers) {\n            const leftover_row = leftovers_table.insert();\n\n            leftover_row.remainder = leftover.data.remainder ?? 0;\n            if (leftover.data.vacation_type_app) leftover_row.vacation_type = leftover.data.vacation_type_app;\n        }\n\n        row.employment_placement = employment_placement;\n        row.leftovers = leftovers_table;\n    }\n\n    Context.data.vacation_leftover_table = vacation_leftover_table;\n}",
    "clientScriptOptions": {
      "allowNamespace": true,
      "allowServer": true
    },
    "serverScripts": "/* Server scripts module */\n",
    "serverScriptOptions": {
      "allowNamespace": true
    }
  },
  "dataNamespace": "",
  "dataCode": "",
  "runtime": {
    "version": 1,
    "clientScripts": "System.register([], function (exports_1, context_1) {\n    \"use strict\";\n    var __moduleName = context_1 \u0026\u0026 context_1.id;\n    function default_1(Context, ViewContext, Server, System) {\n        async function onInit() {\n            getActualLeftovers();\n        }\n        async function getActualLeftovers() {\n            var _a, _b;\n            if (!Context.data.staff) {\n                throw new Error(\"Context.data.staff is undefined\");\n            }\n            const staff = await Context.data.staff.fetch();\n            if (!staff.data.employment_table || staff.data.employment_table.length == 0) {\n                throw new Error(\"У сотрудника не указаны места занятости\");\n            }\n            const vacation_leftovers = await Namespace.app.vacation_leftovers.search()\n                .where((f, g) =\u003e g.and(f.__deletedAt.eq(null), f.staff.link(staff)))\n                .size(10000)\n                .all();\n            const employment_table = (_a = staff.data.employment_table) !== null \u0026\u0026 _a !== void 0 ? _a : staff.fields.employment_table.create();\n            const employment_placement_ids = employment_table\n                .filter(f =\u003e f.employment_placement_app)\n                .map(f =\u003e f.employment_placement_app.id);\n            const employment_placements = await Namespace.app.employment_directory.search()\n                .where((f, g) =\u003e g.and(f.__deletedAt.eq(null), f.__id.in(employment_placement_ids), f.__status.eq(Namespace.app.employment_directory.fields.__status.variants.actual), f.staff.link(staff)))\n                .size(employment_placement_ids.length)\n                .all();\n            const vacation_leftover_table = Context.fields.vacation_leftover_table.create();\n            for (const employment_placement of employment_placements) {\n                if (!employment_placement.data.position)\n                    continue;\n                const leftovers = vacation_leftovers.filter(f =\u003e { var _a, _b; return ((_a = f.data.position) === null || _a === void 0 ? void 0 : _a.id) == ((_b = employment_placement.data.position) === null || _b === void 0 ? void 0 : _b.id); });\n                if (leftovers.length == 0)\n                    continue;\n                const row = vacation_leftover_table.insert();\n                const leftovers_table = Context.fields.vacation_leftover_table.fields.leftovers.create();\n                for (const leftover of leftovers) {\n                    const leftover_row = leftovers_table.insert();\n                    leftover_row.remainder = (_b = leftover.data.remainder) !== null \u0026\u0026 _b !== void 0 ? _b : 0;\n                    if (leftover.data.vacation_type_app)\n                        leftover_row.vacation_type = leftover.data.vacation_type_app;\n                }\n                row.employment_placement = employment_placement;\n                row.leftovers = leftovers_table;\n            }\n            Context.data.vacation_leftover_table = vacation_leftover_table;\n        }\n        return {\n            onInit,\n            getActualLeftovers\n        };\n    }\n    exports_1(\"default\", default_1);\n    return {\n        setters: [],\n        execute: function () {\n        }\n    };\n});\n",
    "clientFnDeclarations": [
      {
        "name": "onInit",
        "parameters": [],
        "type": "[object Object]"
      },
      {
        "name": "getActualLeftovers",
        "parameters": [],
        "type": "[object Object]"
      }
    ],
    "clientDependencies": {
      "applications": [
        {
          "namespace": "kedo",
          "code": "employment_directory"
        }
      ],
      "collections": [
        {
          "namespace": "kedo",
          "code": "staff"
        },
        {
          "namespace": "kedo",
          "code": "vacation_leftovers"
        },
        {
          "namespace": "kedo",
          "code": "employment_directory"
        }
      ],
      "pages": [
        {
          "namespace": "global",
          "code": "kedo"
        }
      ]
    }
  },
  "__createdAt": "2024-04-23T10:16:49.701269144Z",
  "__createdBy": "099fd2a1-8125-406b-aaff-0db06d81aa40",
  "__updatedAt": "2024-04-23T10:16:49.701269144Z",
  "__updatedBy": "099fd2a1-8125-406b-aaff-0db06d81aa40",
  "__deletedAt": null
}
