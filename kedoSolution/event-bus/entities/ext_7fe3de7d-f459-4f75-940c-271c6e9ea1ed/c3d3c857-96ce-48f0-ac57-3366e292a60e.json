{
  "id": "c3d3c857-96ce-48f0-ac57-3366e292a60e",
  "namespace": "ext_7fe3de7d-f459-4f75-940c-271c6e9ea1ed",
  "handlerType": "script",
  "handlerData": {
    "scripts": "class MyRole {\n    group: UserGroupItem | UserItem[] | OrganisationStructureItem\n    type: 'group' | 'user' | 'orgstruct'\n    code: string\n    constructor(group: UserGroupItem | UserItem[] | OrganisationStructureItem, type: 'group' | 'user' | 'orgstruct', code: string) {\n        this.code = code;\n        this.group = group;\n        this.type = type;\n    }\n    getUsers(): Promise\u003cUserItem[]\u003e {\n        if (this.type == \"group\") {\n            return (\u003cUserGroupItem\u003ethis.group).users();\n        }\n        else if (this.type == \"orgstruct\") {\n            return System.users.search().where(i =\u003e i.osIds.has((\u003cOrganisationStructureItem\u003ethis.group))).size(10000).all()\n        }\n        else return new Promise\u003cUserItem[]\u003e(() =\u003e \u003cUserItem[]\u003ethis.group)\n    }\n    json(): any {\n        return {\n            code: this.code,\n            type: this.type\n        }\n    }\n};\n\nlet appCodes = [\n    \"avansovyi_otchet\",\n    \"service_assignments\",\n    \"trip_requests\",\n    \"order_for_a_business_trip\",\n    \"child_personal_data_consent\",\n    \"application_category_assignment\",\n    \"execution_responsibilities_additional_agreement\",\n    \"order_for_transfer\",\n    \"letter_of_resignation\",\n    \"additional_transfer_agreement\",\n    \"order_execution_responsibilities\",\n    \"memo_execution_responsibilities\",\n    \"transfer_approve\",\n    \"docs_1c\",\n    \"labor_contract\",\n    \"passport_data_change_order\",\n    \"electronic_interaction_agreement\",\n    \"additional_agreement_to_the_contract\",\n    \"execution_responsibilities_consent\",\n    \"docs_lna\",\n    \"transfer_application\",\n    \"job_application\",\n    \"additional_agreement\",\n    \"admission_order\",\n    \"dismissal_order\",\n    \"orders_lna\",\n    \"consent_processing_personal_data\",\n    \"recall_dismissal\",\n    \"passport_data_application\",\n    \"personal_documents\",\n    \"information_about_labor_activity\",\n    \"benefit_application\",\n    \"application_for_financial_assistance\",\n    \"setlement_sheet\",\n    \"other_documents\",\n    \"paid_leave\",\n    \"order_financial_assistance\",\n    \"memo_business_trip\",\n    \"application_for_the_transfer_of_salary_to_the_current_account\",\n    \"leave_without_pay\",\n    \"application_for_leave_without_pay\",\n    \"certificate\",\n    \"order_for_business_trip\",\n    \"paid_leave_order\",\n    \"free_from\",\n    \"prochie_dokumenty\",\n    \"vacation_schedule\",\n    \"vacation_orders\",\n    \"offer_vacation_schedule\",\n    \"vacation_docs\",\n    \"mobilization\",\n    \"overtimeWorkOrders\",\n    \"overtimeOrders\",\n    \"overtimeWorkNotifications\",\n    \"overtime_requests\",\n    \"overtimeWorkConsent\",\n    \"overtime_order\",\n    \"staff\",\n    \"transfer_application\",\n    \"execution_duties\",\n    \"category_assignment\",\n    \"employees_personal_data\",\n    \"medical_request\",\n    \"docs_lna\",\n    \"vacations\",\n    \"overtime_work\",\n    \"businesstrip_requests\",\n    \"personnel_documents\",\n    \"structural_subdivision\"\n];\n\nlet customAppCodes: string[] = [];\n\nasync function logError(message: string): Promise\u003cvoid\u003e {\n    const newLogItem = Namespace.params.fields.logs_app.app.create();\n    newLogItem.data.log = message;\n    await newLogItem.save();\n};\n\nasync function action(): Promise\u003cvoid\u003e {\n    const customCodesSetting = await Namespace.params.fields.settings.app.search().where(f =\u003e f.code.eq(\"custom_app_codes\")).first();\n    if (customCodesSetting \u0026\u0026 customCodesSetting.data.value) {\n        customAppCodes = customCodesSetting.data.value.split(\",\").map(code =\u003e code.trim());\n        appCodes = appCodes.concat(customAppCodes);\n    };\n    let appCode = Context.data.__item!.code;\n    if (appCode === \"kedo_logs\") {\n        return;\n    };\n    if (appCodes.indexOf(appCode) == -1 || !Context.data.__item) {\n        // await logError(`app code ${appCode} not in appCodes`)\n        return;\n    };\n    let staff: ApplicationItem\u003cApplication$kedo$staff$Data, any\u003e | undefined;\n    try {\n        if (appCode === \"staff\") {\n            staff = await Namespace.params.fields.employee_app.app.search().where((f, g) =\u003e g.and(\n                f.__deletedAt.eq(null),\n                f.__id.eq(Context.data.item.__id)\n            )).first();\n        } else if  ([\n                \"vacations\",\n                \"vacation_docs\",\n                \"vacation_orders\",\n                \"offer_vacation_schedule\",\n                \"overtime_work\",\n                \"businesstrip_requests\",\n                \"trip_requests\",\n                \"order_for_a_business_trip\",\n                \"avansovyi_otchet\",\n                \"service_assignments\"\n            ].indexOf(appCode) != -1) {\n                try {\n                    staff = await Namespace.params.fields.employee_app.app.search().where((f, g) =\u003e g.and(\n                        f.__deletedAt.eq(null),\n                        f.__id.eq(Context.data.item.kedo_staff[0])\n                    )).first();\n                } catch {\n                    throw new Error(`Cоздание элемента: no staff[0] at ${Context.data.__item.code}/${Context.data.__item.id}`);\n                };\n        } else if (appCode === \"structural_subdivision\") {\n            staff = undefined;\n        } else {\n            try {\n                staff = await Namespace.params.fields.employee_app.app.search().where((f, g) =\u003e g.and(\n                    f.__deletedAt.eq(null),\n                    f.__id.eq(Context.data.item.staff[0])\n                )).first();\n            } catch {\n                throw new Error(`Cоздание элемента: no staff[0] at ${Context.data.__item.code}/${Context.data.__item.id}`)\n            }\n        };\n\n        if (customAppCodes.indexOf(appCode) !== -1) {\n            appCode += \"_extended\"\n        };\n\n        if (staff || appCode === \"structural_subdivision\") {\n            if (staff \u0026\u0026 appCode == \"staff\" \u0026\u0026 staff!.data.employment_table \u0026\u0026 staff!.data.employment_table.length \u003e 1) {\n                const staffOrgs = staff!.data.employment_table.map(row =\u003e row.organization.id);\n                const orgsWithAccessRights = await Namespace.params.fields.org_app.app.search().where((f, g) =\u003e g.and(\n                    f.__deletedAt.eq(null),\n                    f.__id.in(staffOrgs),\n                    f.access_settings_organization.neq(null)\n                )).size(10000).all();\n                const orgsAccessSettings = await Promise.all(orgsWithAccessRights.map(org =\u003e org.data.access_settings_organization!.fetch())).then(accessSettings =\u003e accessSettings.filter(setting =\u003e setting.data.staff));\n                let accessRightsForElement = await Promise.all(orgsAccessSettings.map(async accessSetting =\u003e {\n                    try {\n                        const accessGroup = await System.userGroups.search().where((f ,g) =\u003e g.and(\n                            f.__deletedAt.eq(null),\n                            f.__id.eq(accessSetting.data.staff![0].code)\n                        )).first();\n                        if (accessGroup) {\n                            const newRole = new MyRole(accessGroup, \"group\", accessGroup.id) as Role;\n                            return newRole\n                        };\n                    } catch {\n                        throw new Error(`Cоздание элемента: no code staff at access settings ${accessSetting.id} for item ${Context.data.__item!.code}/${Context.data.__item!.id}`)\n                    };\n                }));\n                accessRightsForElement = accessRightsForElement.filter(item =\u003e item);\n                const itemToChange = await Context.data.__item.fetch();\n                itemToChange.data.access_group = accessRightsForElement\n                await itemToChange.save();\n            } else {\n                if (!staff \u0026\u0026 appCode !== \"structural_subdivision\") {\n                    await logError(`Cоздание элемента: Приложение - не подразделение и не найдено поле staff: ${Context.data.__item.code}/${Context.data.__item.id}`)\n                    return;\n                };\n                if (staff \u0026\u0026 !staff.data.organization) {\n                    await logError(`Cоздание элемента: У сотрудника ${staff.id} не присвоена организация`)\n                    return;\n                }\n\n                let organization: ApplicationItem\u003cApplication$kedo$organization$Data, any\u003e | undefined;\n\n                try {\n                    organization = appCode == \"structural_subdivision\" ? await Namespace.params.fields.org_app.app.search().where((f, g) =\u003e g.and(\n                        f.__deletedAt.eq(null),\n                        f.__id.eq(Context.data.item.organization[0])\n                    )).first() : await staff!.data.organization!.fetch();\n                } catch {\n                    throw new Error(`Cоздание элемента: no organization for item ${Context.data.__item.code}/${Context.data.__item.id}`)\n                };\n\n                if (!organization || !organization.data.access_settings_organization) {\n                    await logError(`Cоздание элемента: У сотрудника ${staff!.id} не присвоена организация или у организации ${organization ? organization.id : \"undefined\"} не привязаны настройки доступа`);\n                    return;\n                };\n                const accessSettings = await organization.data.access_settings_organization.fetch();\n                if (!accessSettings.data[appCode as keyof typeof accessSettings.data] || accessSettings.data[appCode as keyof typeof accessSettings.data].length \u003c 1) {\n                    await logError(`Cоздание элемента: У настроек доступа ${accessSettings!.id} не заполнено поле ${appCode}`);\n                    return;\n                };\n\n                let accessGroup: UserGroupItem | undefined\n\n                try {\n                    accessGroup = await System.userGroups.search().where((f ,g) =\u003e g.and(\n                        f.__deletedAt.eq(null),\n                        f.__id.eq(accessSettings.data[appCode as keyof typeof accessSettings.data]![0].code)\n                    )).first();\n                } catch {\n                    throw new Error(`no field ${appCode} at access setting ${accessSettings.id}`);\n                };\n\n                if (accessGroup) {\n                    const newRole = new MyRole(accessGroup, \"group\", accessGroup.id) as Role\n                    const itemToChange = await Context.data.__item.fetch();\n                    itemToChange.data.access_group = [newRole];\n                    await itemToChange.save();\n                } else {\n                    await logError(`Cоздание элемента: Не найдена группа с id ${accessSettings.data[appCode as keyof typeof accessSettings.data]![0].code}`);\n                    return;\n                };\n            }\n        } else {\n            await logError(`Cоздание элемента: Не заполнено поле staff у ${Context.data.__item.code}/${Context.data.__item.id}`);\n            return;\n        }\n\n    } catch (err) {\n        await logError(`Cоздание элемента: ${Context.data.__item.code}/${Context.data.__item.id} : ${err.message}`)\n        return;\n    }\n};\n    ",
    "scriptsOptions": {},
    "compiledScripts": "class MyRole {\n    constructor(group, type, code) {\n        this.code = code;\n        this.group = group;\n        this.type = type;\n    }\n    getUsers() {\n        if (this.type == \"group\") {\n            return this.group.users();\n        }\n        else if (this.type == \"orgstruct\") {\n            return System.users.search().where(i =\u003e i.osIds.has(this.group)).size(10000).all();\n        }\n        else\n            return new Promise(() =\u003e this.group);\n    }\n    json() {\n        return {\n            code: this.code,\n            type: this.type\n        };\n    }\n}\n;\nlet appCodes = [\n    \"avansovyi_otchet\",\n    \"service_assignments\",\n    \"trip_requests\",\n    \"order_for_a_business_trip\",\n    \"child_personal_data_consent\",\n    \"application_category_assignment\",\n    \"execution_responsibilities_additional_agreement\",\n    \"order_for_transfer\",\n    \"letter_of_resignation\",\n    \"additional_transfer_agreement\",\n    \"order_execution_responsibilities\",\n    \"memo_execution_responsibilities\",\n    \"transfer_approve\",\n    \"docs_1c\",\n    \"labor_contract\",\n    \"passport_data_change_order\",\n    \"electronic_interaction_agreement\",\n    \"additional_agreement_to_the_contract\",\n    \"execution_responsibilities_consent\",\n    \"docs_lna\",\n    \"transfer_application\",\n    \"job_application\",\n    \"additional_agreement\",\n    \"admission_order\",\n    \"dismissal_order\",\n    \"orders_lna\",\n    \"consent_processing_personal_data\",\n    \"recall_dismissal\",\n    \"passport_data_application\",\n    \"personal_documents\",\n    \"information_about_labor_activity\",\n    \"benefit_application\",\n    \"application_for_financial_assistance\",\n    \"setlement_sheet\",\n    \"other_documents\",\n    \"paid_leave\",\n    \"order_financial_assistance\",\n    \"memo_business_trip\",\n    \"application_for_the_transfer_of_salary_to_the_current_account\",\n    \"leave_without_pay\",\n    \"application_for_leave_without_pay\",\n    \"certificate\",\n    \"order_for_business_trip\",\n    \"paid_leave_order\",\n    \"free_from\",\n    \"prochie_dokumenty\",\n    \"vacation_schedule\",\n    \"vacation_orders\",\n    \"offer_vacation_schedule\",\n    \"vacation_docs\",\n    \"mobilization\",\n    \"overtimeWorkOrders\",\n    \"overtimeOrders\",\n    \"overtimeWorkNotifications\",\n    \"overtime_requests\",\n    \"overtimeWorkConsent\",\n    \"overtime_order\",\n    \"staff\",\n    \"transfer_application\",\n    \"execution_duties\",\n    \"category_assignment\",\n    \"employees_personal_data\",\n    \"medical_request\",\n    \"docs_lna\",\n    \"vacations\",\n    \"overtime_work\",\n    \"businesstrip_requests\",\n    \"personnel_documents\",\n    \"structural_subdivision\"\n];\nlet customAppCodes = [];\nasync function logError(message) {\n    const newLogItem = Namespace.params.fields.logs_app.app.create();\n    newLogItem.data.log = message;\n    await newLogItem.save();\n}\n;\nasync function action() {\n    const customCodesSetting = await Namespace.params.fields.settings.app.search().where(f =\u003e f.code.eq(\"custom_app_codes\")).first();\n    if (customCodesSetting \u0026\u0026 customCodesSetting.data.value) {\n        customAppCodes = customCodesSetting.data.value.split(\",\").map(code =\u003e code.trim());\n        appCodes = appCodes.concat(customAppCodes);\n    }\n    ;\n    let appCode = Context.data.__item.code;\n    if (appCode === \"kedo_logs\") {\n        return;\n    }\n    ;\n    if (appCodes.indexOf(appCode) == -1 || !Context.data.__item) {\n        return;\n    }\n    ;\n    let staff;\n    try {\n        if (appCode === \"staff\") {\n            staff = await Namespace.params.fields.employee_app.app.search().where((f, g) =\u003e g.and(f.__deletedAt.eq(null), f.__id.eq(Context.data.item.__id))).first();\n        }\n        else if ([\n            \"vacations\",\n            \"vacation_docs\",\n            \"vacation_orders\",\n            \"offer_vacation_schedule\",\n            \"overtime_work\",\n            \"businesstrip_requests\",\n            \"trip_requests\",\n            \"order_for_a_business_trip\",\n            \"avansovyi_otchet\",\n            \"service_assignments\"\n        ].indexOf(appCode) != -1) {\n            try {\n                staff = await Namespace.params.fields.employee_app.app.search().where((f, g) =\u003e g.and(f.__deletedAt.eq(null), f.__id.eq(Context.data.item.kedo_staff[0]))).first();\n            }\n            catch (_a) {\n                throw new Error(`Cоздание элемента: no staff[0] at ${Context.data.__item.code}/${Context.data.__item.id}`);\n            }\n            ;\n        }\n        else if (appCode === \"structural_subdivision\") {\n            staff = undefined;\n        }\n        else {\n            try {\n                staff = await Namespace.params.fields.employee_app.app.search().where((f, g) =\u003e g.and(f.__deletedAt.eq(null), f.__id.eq(Context.data.item.staff[0]))).first();\n            }\n            catch (_b) {\n                throw new Error(`Cоздание элемента: no staff[0] at ${Context.data.__item.code}/${Context.data.__item.id}`);\n            }\n        }\n        ;\n        if (customAppCodes.indexOf(appCode) !== -1) {\n            appCode += \"_extended\";\n        }\n        ;\n        if (staff || appCode === \"structural_subdivision\") {\n            if (staff \u0026\u0026 appCode == \"staff\" \u0026\u0026 staff.data.employment_table \u0026\u0026 staff.data.employment_table.length \u003e 1) {\n                const staffOrgs = staff.data.employment_table.map(row =\u003e row.organization.id);\n                const orgsWithAccessRights = await Namespace.params.fields.org_app.app.search().where((f, g) =\u003e g.and(f.__deletedAt.eq(null), f.__id.in(staffOrgs), f.access_settings_organization.neq(null))).size(10000).all();\n                const orgsAccessSettings = await Promise.all(orgsWithAccessRights.map(org =\u003e org.data.access_settings_organization.fetch())).then(accessSettings =\u003e accessSettings.filter(setting =\u003e setting.data.staff));\n                let accessRightsForElement = await Promise.all(orgsAccessSettings.map(async (accessSetting) =\u003e {\n                    try {\n                        const accessGroup = await System.userGroups.search().where((f, g) =\u003e g.and(f.__deletedAt.eq(null), f.__id.eq(accessSetting.data.staff[0].code))).first();\n                        if (accessGroup) {\n                            const newRole = new MyRole(accessGroup, \"group\", accessGroup.id);\n                            return newRole;\n                        }\n                        ;\n                    }\n                    catch (_a) {\n                        throw new Error(`Cоздание элемента: no code staff at access settings ${accessSetting.id} for item ${Context.data.__item.code}/${Context.data.__item.id}`);\n                    }\n                    ;\n                }));\n                accessRightsForElement = accessRightsForElement.filter(item =\u003e item);\n                const itemToChange = await Context.data.__item.fetch();\n                itemToChange.data.access_group = accessRightsForElement;\n                await itemToChange.save();\n            }\n            else {\n                if (!staff \u0026\u0026 appCode !== \"structural_subdivision\") {\n                    await logError(`Cоздание элемента: Приложение - не подразделение и не найдено поле staff: ${Context.data.__item.code}/${Context.data.__item.id}`);\n                    return;\n                }\n                ;\n                if (staff \u0026\u0026 !staff.data.organization) {\n                    await logError(`Cоздание элемента: У сотрудника ${staff.id} не присвоена организация`);\n                    return;\n                }\n                let organization;\n                try {\n                    organization = appCode == \"structural_subdivision\" ? await Namespace.params.fields.org_app.app.search().where((f, g) =\u003e g.and(f.__deletedAt.eq(null), f.__id.eq(Context.data.item.organization[0]))).first() : await staff.data.organization.fetch();\n                }\n                catch (_c) {\n                    throw new Error(`Cоздание элемента: no organization for item ${Context.data.__item.code}/${Context.data.__item.id}`);\n                }\n                ;\n                if (!organization || !organization.data.access_settings_organization) {\n                    await logError(`Cоздание элемента: У сотрудника ${staff.id} не присвоена организация или у организации ${organization ? organization.id : \"undefined\"} не привязаны настройки доступа`);\n                    return;\n                }\n                ;\n                const accessSettings = await organization.data.access_settings_organization.fetch();\n                if (!accessSettings.data[appCode] || accessSettings.data[appCode].length \u003c 1) {\n                    await logError(`Cоздание элемента: У настроек доступа ${accessSettings.id} не заполнено поле ${appCode}`);\n                    return;\n                }\n                ;\n                let accessGroup;\n                try {\n                    accessGroup = await System.userGroups.search().where((f, g) =\u003e g.and(f.__deletedAt.eq(null), f.__id.eq(accessSettings.data[appCode][0].code))).first();\n                }\n                catch (_d) {\n                    throw new Error(`no field ${appCode} at access setting ${accessSettings.id}`);\n                }\n                ;\n                if (accessGroup) {\n                    const newRole = new MyRole(accessGroup, \"group\", accessGroup.id);\n                    const itemToChange = await Context.data.__item.fetch();\n                    itemToChange.data.access_group = [newRole];\n                    await itemToChange.save();\n                }\n                else {\n                    await logError(`Cоздание элемента: Не найдена группа с id ${accessSettings.data[appCode][0].code}`);\n                    return;\n                }\n                ;\n            }\n        }\n        else {\n            await logError(`Cоздание элемента: Не заполнено поле staff у ${Context.data.__item.code}/${Context.data.__item.id}`);\n            return;\n        }\n    }\n    catch (err) {\n        await logError(`Cоздание элемента: ${Context.data.__item.code}/${Context.data.__item.id} : ${err.message}`);\n        return;\n    }\n}\n;\n(async function () {\n    action();\n});\n"
  },
  "name": "Присвоение групп доступа",
  "company": "head",
  "entityNamespace": "",
  "entityCode": "",
  "entityId": "",
  "event": "item_create",
  "expiredAt": null,
  "createdAt": "2024-02-14T11:10:58.762281Z",
  "createdBy": "7303b866-4220-4086-a09e-348a76b12c73",
  "updatedAt": "2024-03-22T05:05:02.323023Z",
  "updatedBy": "d4c0aacb-19ed-44fa-b229-5f7ed736889c"
}
